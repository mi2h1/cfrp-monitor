<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFRPè¨˜äº‹ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar {
            background-color: #0d6efd !important;
        }
        .article-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
        }
        .article-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .article-body {
            max-height: 150px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .flagged {
            border-left: 4px solid #dc3545;
        }
        .controls {
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">CFRP Monitor <small class="text-white-50" style="font-size: 0.7rem;">v2025.01.08.6</small></a>
            <div class="navbar-nav">
                <a class="nav-link active" href="index.html">ğŸ“° è¨˜äº‹ç®¡ç†</a>
                <a class="nav-link" href="sources.html">ğŸ“¡ æƒ…å ±æºç®¡ç†</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <header class="mb-4">
            <h1 class="h2">CFRPè¨˜äº‹ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="statusFilter" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                    <select id="statusFilter" class="form-select form-select-sm">
                        <option value="">å…¨ã¦</option>
                        <option value="unread">æœªèª­</option>
                        <option value="reviewed">ç¢ºèªæ¸ˆã¿</option>
                        <option value="flagged">ãƒ•ãƒ©ã‚°ä»˜ã</option>
                        <option value="archived">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="flaggedFilter" class="form-label">é‡è¦:</label>
                    <select id="flaggedFilter" class="form-select form-select-sm">
                        <option value="">å…¨ã¦</option>
                        <option value="true">é‡è¦ã®ã¿</option>
                        <option value="false">é€šå¸¸ã®ã¿</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="sourceFilter" class="form-label">ã‚½ãƒ¼ã‚¹:</label>
                    <select id="sourceFilter" class="form-select form-select-sm">
                        <option value="">å…¨ã¦</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="sortOrder" class="form-label">ä¸¦ã³é †:</label>
                    <select id="sortOrder" class="form-select form-select-sm">
                        <option value="desc">æ–°ã—ã„é †</option>
                        <option value="asc">å¤ã„é †</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="itemsPerPage" class="form-label">è¡¨ç¤ºä»¶æ•°:</label>
                    <select id="itemsPerPage" class="form-select form-select-sm">
                        <option value="10">10ä»¶</option>
                        <option value="30">30ä»¶</option>
                        <option value="50">50ä»¶</option>
                        <option value="100" selected>100ä»¶</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button id="refreshBtn" class="btn btn-primary btn-sm">æ›´æ–°</button>
                </div>
            </div>
        </header>

        <div id="loading" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <p>è¨˜äº‹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>

        <div id="articlesContainer" style="display: none;"></div>
        
        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav id="pagination" aria-label="è¨˜äº‹ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div id="pageInfo" class="text-muted"></div>
                <ul class="pagination pagination-sm mb-0" id="paginationList">
                </ul>
            </div>
        </nav>
    </div>

    <script>
        // Supabaseã®è¨­å®š
        const SUPABASE_URL = 'https://nvchsqotmchzpharujap.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52Y2hzcW90bWNoenBoYXJ1amFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMDc2OTAsImV4cCI6MjA2MDg4MzY5MH0.h6MdiDYNySabXxpeS_92KWuwUQlavQqv-9GJyKCn2jo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let articles = [];
        let sources = [];
        let currentPage = 1;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSources();
            await loadArticles();
            setupEventListeners();
        });

        // ã‚½ãƒ¼ã‚¹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadSources() {
            try {
                const { data, error } = await supabase
                    .from('sources')
                    .select('id, name, domain')
                    .order('name');
                
                if (error) throw error;
                
                sources = data || [];
                populateSourceFilter();
            } catch (error) {
                console.error('ã‚½ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è¨˜äº‹ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadArticles() {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .select(`
                        *,
                        sources(name, domain)
                    `)
                    .order('pub_date', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                articles = data || [];
                currentPage = 1; // ãƒšãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
                renderArticles();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('articlesContainer').style.display = 'block';
                document.getElementById('pagination').style.display = 'block';
            } catch (error) {
                console.error('è¨˜äº‹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="alert alert-danger">è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ã‚½ãƒ¼ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®š
        function populateSourceFilter() {
            const select = document.getElementById('sourceFilter');
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source.id;
                option.textContent = source.name || source.domain;
                select.appendChild(option);
            });
        }

        // è¨˜äº‹ã‚’è¡¨ç¤º
        function renderArticles() {
            const container = document.getElementById('articlesContainer');
            const filteredArticles = filterAndSortArticles();
            const itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            
            if (filteredArticles.length === 0) {
                container.innerHTML = '<div class="alert alert-info">è©²å½“ã™ã‚‹è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
            const totalPages = Math.ceil(filteredArticles.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedArticles = filteredArticles.slice(startIndex, endIndex);

            // ãƒšãƒ¼ã‚¸ãŒç¯„å›²å¤–ã®å ´åˆã¯1ãƒšãƒ¼ã‚¸ç›®ã«æˆ»ã™
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = 1;
                renderArticles();
                return;
            }

            // è¨˜äº‹è¡¨ç¤º
            container.innerHTML = paginatedArticles.map(article => createArticleCard(article)).join('');
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
            renderPagination(filteredArticles.length, itemsPerPage, totalPages);
            document.getElementById('pagination').style.display = 'block';
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆ
        function filterAndSortArticles() {
            const statusFilter = document.getElementById('statusFilter').value;
            const flaggedFilter = document.getElementById('flaggedFilter').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filtered = articles.filter(article => {
                if (statusFilter && article.status !== statusFilter) return false;
                if (flaggedFilter && String(article.flagged) !== flaggedFilter) return false;
                if (sourceFilter && article.source_id !== sourceFilter) return false;
                return true;
            });

            // ã‚½ãƒ¼ãƒˆ
            filtered.sort((a, b) => {
                const dateA = new Date(a.pub_date || a.added_at || 0);
                const dateB = new Date(b.pub_date || b.added_at || 0);
                
                if (sortOrder === 'asc') {
                    return dateA - dateB; // å¤ã„é †
                } else {
                    return dateB - dateA; // æ–°ã—ã„é †
                }
            });

            return filtered;
        }

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function renderPagination(totalItems, itemsPerPage, totalPages) {
            const pageInfo = document.getElementById('pageInfo');
            const paginationList = document.getElementById('paginationList');
            
            // ãƒšãƒ¼ã‚¸æƒ…å ±è¡¨ç¤º
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            pageInfo.textContent = `${startItem}-${endItem} / ${totalItems}ä»¶ (${currentPage}/${totalPages}ãƒšãƒ¼ã‚¸)`;
            
            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç”Ÿæˆ
            paginationList.innerHTML = '';
            
            // å‰ã¸ãƒœã‚¿ãƒ³
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">å‰ã¸</a>`;
            paginationList.appendChild(prevLi);
            
            // ãƒšãƒ¼ã‚¸ç•ªå·ãƒœã‚¿ãƒ³
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // èª¿æ•´
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // æœ€åˆã®ãƒšãƒ¼ã‚¸ãŒè¦‹ãˆãªã„å ´åˆ
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = '<a class="page-link" href="#" data-page="1">1</a>';
                paginationList.appendChild(firstLi);
                
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    paginationList.appendChild(ellipsisLi);
                }
            }
            
            // ãƒšãƒ¼ã‚¸ç•ªå·
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                paginationList.appendChild(li);
            }
            
            // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ãŒè¦‹ãˆãªã„å ´åˆ
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    paginationList.appendChild(ellipsisLi);
                }
                
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
                paginationList.appendChild(lastLi);
            }
            
            // æ¬¡ã¸ãƒœã‚¿ãƒ³
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">æ¬¡ã¸</a>`;
            paginationList.appendChild(nextLi);
        }

        // è¨˜äº‹ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createArticleCard(article) {
            const sourceName = article.sources?.name || article.sources?.domain || 'Unknown';
            const pubDate = article.pub_date ? new Date(article.pub_date).toLocaleDateString('ja-JP') : 'ä¸æ˜';
            const flaggedClass = article.flagged ? 'flagged' : '';
            
            return `
                <div class="article-card ${flaggedClass}" data-id="${article.id}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="mb-1">
                            <a href="${article.url}" target="_blank" class="text-decoration-none">
                                ${escapeHtml(article.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—')}
                            </a>
                        </h5>
                        <span class="badge bg-${getStatusColor(article.status)} status-badge">
                            ${getStatusLabel(article.status)}
                        </span>
                    </div>
                    
                    <div class="article-meta mb-2">
                        <span class="me-3">ğŸ“… ${pubDate}</span>
                        <span class="me-3">ğŸ“° ${sourceName}</span>
                        ${article.flagged ? '<span class="badge bg-danger">é‡è¦</span>' : ''}
                    </div>
                    
                    ${article.body ? `
                        <div class="article-body">
                            ${escapeHtml(article.body.substring(0, 300))}${article.body.length > 300 ? '...' : ''}
                        </div>
                    ` : ''}
                    
                    <div class="controls">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label small">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
                                <select class="form-select form-select-sm status-select" data-id="${article.id}">
                                    <option value="unread" ${article.status === 'unread' ? 'selected' : ''}>æœªèª­</option>
                                    <option value="reviewed" ${article.status === 'reviewed' ? 'selected' : ''}>ç¢ºèªæ¸ˆã¿</option>
                                    <option value="flagged" ${article.status === 'flagged' ? 'selected' : ''}>ãƒ•ãƒ©ã‚°ä»˜ã</option>
                                    <option value="archived" ${article.status === 'archived' ? 'selected' : ''}>ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">é‡è¦:</label>
                                <div class="form-check">
                                    <input class="form-check-input flagged-check" type="checkbox" 
                                           data-id="${article.id}" ${article.flagged ? 'checked' : ''}>
                                    <label class="form-check-label small">é‡è¦ãƒ•ãƒ©ã‚°</label>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <label class="form-label small">ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
                                <textarea class="form-control form-control-sm comment-textarea" 
                                         data-id="${article.id}" rows="2" 
                                         placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">${escapeHtml(article.comments || '')}</textarea>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success btn-sm save-btn" data-id="${article.id}">ä¿å­˜</button>
                            ${article.reviewed_at ? `<small class="text-muted ms-2">æœ€çµ‚æ›´æ–°: ${new Date(article.reviewed_at).toLocaleString('ja-JP')}</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²ã‚’å–å¾—
        function getStatusColor(status) {
            const colors = {
                'unread': 'secondary',
                'reviewed': 'success',
                'flagged': 'warning',
                'archived': 'dark'
            };
            return colors[status] || 'secondary';
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        function getStatusLabel(status) {
            const labels = {
                'unread': 'æœªèª­',
                'reviewed': 'ç¢ºèªæ¸ˆã¿',
                'flagged': 'ãƒ•ãƒ©ã‚°ä»˜ã',
                'archived': 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'
            };
            return labels[status] || 'æœªèª­';
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        function setupEventListeners() {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆãƒ»è¡¨ç¤ºä»¶æ•°å¤‰æ›´æ™‚
            ['statusFilter', 'flaggedFilter', 'sourceFilter', 'sortOrder', 'itemsPerPage'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    currentPage = 1; // ãƒšãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
                    renderArticles();
                });
            });

            // æ›´æ–°ãƒœã‚¿ãƒ³
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                document.getElementById('refreshBtn').disabled = true;
                await loadArticles();
                document.getElementById('refreshBtn').disabled = false;
            });

            // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
            document.getElementById('articlesContainer').addEventListener('click', async (e) => {
                if (e.target.classList.contains('save-btn')) {
                    await saveArticle(e.target.dataset.id);
                }
            });

            // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
            document.getElementById('paginationList').addEventListener('click', (e) => {
                e.preventDefault();
                if (e.target.classList.contains('page-link') && !e.target.closest('.disabled')) {
                    const page = parseInt(e.target.dataset.page);
                    if (page && page !== currentPage) {
                        currentPage = page;
                        renderArticles();
                        // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        document.getElementById('articlesContainer').scrollIntoView({ behavior: 'smooth' });
                    }
                }
            });
        }

        // è¨˜äº‹ã‚’ä¿å­˜
        async function saveArticle(articleId) {
            const card = document.querySelector(`[data-id="${articleId}"]`);
            const status = card.querySelector('.status-select').value;
            const flagged = card.querySelector('.flagged-check').checked;
            const comments = card.querySelector('.comment-textarea').value;
            
            try {
                const { error } = await supabase
                    .from('items')
                    .update({
                        status: status,
                        flagged: flagged,
                        comments: comments || null,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', articleId);
                
                if (error) throw error;
                
                // UIã‚’æ›´æ–°
                const saveBtn = card.querySelector('.save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'ä¿å­˜æ¸ˆã¿';
                saveBtn.classList.replace('btn-success', 'btn-outline-success');
                
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.replace('btn-outline-success', 'btn-success');
                }, 2000);
                
                // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
                await loadArticles();
                
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>