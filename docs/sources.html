<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情報源管理ダッシュボード - CFRP Monitor</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .source-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
            transition: all 0.2s ease;
        }
        .source-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .source-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .disabled-source {
            opacity: 0.6;
            border-left: 4px solid #dc3545;
        }
        .manual-source {
            border-left: 4px solid #ffc107;
        }
        .auto-source {
            border-left: 4px solid #198754;
        }
        .controls {
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .navbar {
            background-color: #0d6efd !important;
        }
        .url-list {
            max-height: 100px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .policy-url {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .url-editor {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .url-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            gap: 0.5rem;
        }
        .url-input {
            flex: 1;
        }
        .url-actions {
            display: flex;
            gap: 0.25rem;
        }
        .add-url-section {
            border-top: 1px solid #dee2e6;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        .compact-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        .compact-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .compact-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .compact-main {
            flex: 1;
            min-width: 200px;
        }
        .compact-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: #6c757d;
            flex-wrap: wrap;
        }
        .edit-mode-container {
            display: none;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9ff;
        }
        .edit-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        .btn-close-edit {
            margin-left: auto;
        }
    </style>
</head>
<body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">CFRP Monitor</a>
            <div class="navbar-nav">
                <a class="nav-link" href="index.html">📰 記事管理</a>
                <a class="nav-link active" href="sources.html">📡 情報源管理</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <header class="mb-4">
            <h1 class="h2">情報源管理ダッシュボード</h1>
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="modeFilter" class="form-label">取得モード:</label>
                    <select id="modeFilter" class="form-select form-select-sm">
                        <option value="">全て</option>
                        <option value="auto">自動収集</option>
                        <option value="manual">手動のみ</option>
                        <option value="disabled">無効</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="categoryFilter" class="form-label">カテゴリ:</label>
                    <select id="categoryFilter" class="form-select form-select-sm">
                        <option value="">全て</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="countryFilter" class="form-label">国:</label>
                    <select id="countryFilter" class="form-select form-select-sm">
                        <option value="">全て</option>
                    </select>
                </div>
                <div class="col-auto">
                    <label for="sortOrder" class="form-label">並び順:</label>
                    <select id="sortOrder" class="form-select form-select-sm">
                        <option value="name">名前順</option>
                        <option value="mode">モード順</option>
                        <option value="relevance">関連度順</option>
                        <option value="created">作成日順</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button id="refreshBtn" class="btn btn-primary btn-sm">更新</button>
                </div>
            </div>
        </header>

        <div id="loading" class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">読み込み中...</span>
            </div>
            <p>情報源を読み込んでいます...</p>
        </div>

        <!-- 統計情報 -->
        <div id="statsContainer" class="mb-3" style="display: none;">
            <div class="d-flex gap-3 align-items-center flex-wrap">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2 fs-6" id="autoCount">0</span>
                    <span class="text-muted">自動収集中</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-warning me-2 fs-6" id="manualCount">0</span>
                    <span class="text-muted">手動のみ</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger me-2 fs-6" id="disabledCount">0</span>
                    <span class="text-muted">無効</span>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2 fs-6" id="totalCount">0</span>
                    <span class="text-muted">総計</span>
                </div>
            </div>
        </div>

        <!-- 編集モード -->
        <div id="editModeContainer" class="edit-mode-container">
            <div class="edit-header">
                <h5 class="mb-0">情報源編集</h5>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-close-edit">✕ 閉じる</button>
            </div>
            <div id="editModeContent"></div>
        </div>

        <div id="sourcesContainer" style="display: none;"></div>
    </div>

    <script>
        // Supabaseの設定
        const SUPABASE_URL = 'https://nvchsqotmchzpharujap.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52Y2hzcW90bWNoenBoYXJ1amFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMDc2OTAsImV4cCI6MjA2MDg4MzY5MH0.h6MdiDYNySabXxpeS_92KWuwUQlavQqv-9GJyKCn2jo';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let sources = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSources();
            setupEventListeners();
        });

        // 情報源一覧を読み込み
        async function loadSources() {
            try {
                const { data, error } = await supabase
                    .from('sources')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                
                sources = data || [];
                populateFilters();
                renderSources();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sourcesContainer').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'block';
            } catch (error) {
                console.error('情報源読み込みエラー:', error);
                document.getElementById('loading').innerHTML = 
                    '<div class="alert alert-danger">情報源の読み込みに失敗しました</div>';
            }
        }

        // フィルターを設定
        function populateFilters() {
            // カテゴリフィルター
            const categories = [...new Set(sources.map(s => s.category).filter(Boolean))];
            const categorySelect = document.getElementById('categoryFilter');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });

            // 国フィルター
            const countries = [...new Set(sources.map(s => s.country_code).filter(Boolean))];
            const countrySelect = document.getElementById('countryFilter');
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });
        }

        // 統計情報を更新
        function updateStats() {
            const filtered = filterAndSortSources();
            const stats = {
                auto: filtered.filter(s => s.acquisition_mode === 'auto').length,
                manual: filtered.filter(s => s.acquisition_mode === 'manual').length,
                disabled: filtered.filter(s => s.acquisition_mode === 'disabled').length,
                total: filtered.length
            };

            document.getElementById('autoCount').textContent = stats.auto;
            document.getElementById('manualCount').textContent = stats.manual;
            document.getElementById('disabledCount').textContent = stats.disabled;
            document.getElementById('totalCount').textContent = stats.total;
        }

        // 情報源を表示
        function renderSources() {
            const container = document.getElementById('sourcesContainer');
            const filteredSources = filterAndSortSources();
            
            if (filteredSources.length === 0) {
                container.innerHTML = '<div class="alert alert-info">該当する情報源がありません</div>';
                return;
            }

            container.innerHTML = filteredSources.map(source => createCompactSourceCard(source)).join('');
            updateStats();
        }

        // フィルタリングとソート
        function filterAndSortSources() {
            const modeFilter = document.getElementById('modeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // フィルタリング
            let filtered = sources.filter(source => {
                if (modeFilter && source.acquisition_mode !== modeFilter) return false;
                if (categoryFilter && source.category !== categoryFilter) return false;
                if (countryFilter && source.country_code !== countryFilter) return false;
                return true;
            });

            // ソート
            filtered.sort((a, b) => {
                switch (sortOrder) {
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'mode':
                        return (a.acquisition_mode || '').localeCompare(b.acquisition_mode || '');
                    case 'relevance':
                        return (b.relevance || 0) - (a.relevance || 0);
                    case 'created':
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                    default:
                        return 0;
                }
            });

            return filtered;
        }

        // コンパクトな情報源カードを作成
        function createCompactSourceCard(source) {
            const modeClass = source.acquisition_mode === 'disabled' ? 'disabled-source' :
                             source.acquisition_mode === 'manual' ? 'manual-source' : 'auto-source';
            
            const urls = Array.isArray(source.urls) ? source.urls : [];
            const primaryUrl = urls.length > 0 ? urls[0] : source.domain;
            
            return `
                <div class="compact-card ${modeClass}" data-id="${source.id}">
                    <div class="compact-info">
                        <div class="compact-main">
                            <h6 class="mb-1">${escapeHtml(source.name || source.domain)}</h6>
                            <div class="small text-muted">${escapeHtml(primaryUrl)}</div>
                        </div>
                        <div class="compact-meta">
                            <span>📂 ${source.category || 'その他'}</span>
                            <span>🌍 ${source.country_code || '?'}</span>
                            <span>⭐ ${source.relevance || 0}</span>
                            <span class="badge bg-${getModeColor(source.acquisition_mode)} ms-2">
                                ${getModeLabel(source.acquisition_mode)}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // 詳細編集用の情報源カードを作成
        function createDetailSourceCard(source) {
            const modeClass = source.acquisition_mode === 'disabled' ? 'disabled-source' :
                             source.acquisition_mode === 'manual' ? 'manual-source' : 'auto-source';
            
            const urls = Array.isArray(source.urls) ? source.urls : [];
            const policyUrl = source.policy_url;
            
            return `
                <div class="source-card ${modeClass}" data-id="${source.id}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="mb-1">
                            ${escapeHtml(source.name || source.domain)}
                        </h5>
                        <span class="badge bg-${getModeColor(source.acquisition_mode)} status-badge">
                            ${getModeLabel(source.acquisition_mode)}
                        </span>
                    </div>
                    
                    <div class="source-meta mb-2">
                        <span class="me-3">🌐 ${source.domain}</span>
                        <span class="me-3">📂 ${source.category || 'その他'}</span>
                        <span class="me-3">🌍 ${source.country_code || 'Unknown'}</span>
                        <span class="me-3">⭐ ${source.relevance || 0}</span>
                    </div>
                    
                    <div class="url-editor mb-2">
                        <strong>RSS/URL:</strong>
                        <div class="url-container" data-id="${source.id}">
                            ${urls.map((url, index) => `
                                <div class="url-item" data-index="${index}">
                                    <input type="url" class="form-control form-control-sm url-input" 
                                           value="${escapeHtml(url)}" placeholder="https://example.com/feed.xml">
                                    <div class="url-actions">
                                        <button class="btn btn-outline-primary btn-sm test-url-btn" 
                                                data-url="${escapeHtml(url)}" title="URLをテスト">
                                            🔍
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm remove-url-btn" 
                                                title="URLを削除">
                                            ✕
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            <div class="add-url-section">
                                <div class="input-group input-group-sm">
                                    <input type="url" class="form-control new-url-input" 
                                           placeholder="新しいURLを追加...">
                                    <button class="btn btn-outline-success add-url-btn" type="button">
                                        ➕ 追加
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${policyUrl ? `
                        <div class="policy-url">
                            <strong>プライバシーポリシー:</strong> 
                            <a href="${policyUrl}" target="_blank" class="text-decoration-none small">${policyUrl}</a>
                        </div>
                    ` : ''}
                    
                    <div class="controls">
                        <div class="row g-2">
                            <div class="col-md-3">
                                <label class="form-label small">取得モード:</label>
                                <select class="form-select form-select-sm mode-select" data-id="${source.id}">
                                    <option value="auto" ${source.acquisition_mode === 'auto' ? 'selected' : ''}>自動収集</option>
                                    <option value="manual" ${source.acquisition_mode === 'manual' ? 'selected' : ''}>手動のみ</option>
                                    <option value="disabled" ${source.acquisition_mode === 'disabled' ? 'selected' : ''}>無効</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">関連度:</label>
                                <input type="number" class="form-control form-control-sm relevance-input" 
                                       data-id="${source.id}" value="${source.relevance || 0}" min="0" max="10">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label small">メモ:</label>
                                <textarea class="form-control form-control-sm notes-textarea" 
                                         data-id="${source.id}" rows="2" 
                                         placeholder="メモを入力...">${escapeHtml(source.notes || '')}</textarea>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-success btn-sm save-btn w-100" data-id="${source.id}">保存</button>
                            </div>
                        </div>
                        ${source.updated_at ? `<div class="mt-2"><small class="text-muted">最終更新: ${new Date(source.updated_at).toLocaleString('ja-JP')}</small></div>` : ''}
                    </div>
                </div>
            `;
        }

        // モードの色を取得
        function getModeColor(mode) {
            const colors = {
                'auto': 'success',
                'manual': 'warning',
                'disabled': 'danger'
            };
            return colors[mode] || 'secondary';
        }

        // モードのラベルを取得
        function getModeLabel(mode) {
            const labels = {
                'auto': '自動収集',
                'manual': '手動のみ',
                'disabled': '無効'
            };
            return labels[mode] || '不明';
        }

        // HTMLエスケープ
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // イベントリスナーを設定
        function setupEventListeners() {
            // フィルター・ソート変更時
            ['modeFilter', 'categoryFilter', 'countryFilter', 'sortOrder'].forEach(id => {
                document.getElementById(id).addEventListener('change', renderSources);
            });

            // 更新ボタン
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                document.getElementById('refreshBtn').disabled = true;
                await loadSources();
                document.getElementById('refreshBtn').disabled = false;
            });

            // コンパクトカードクリックのイベント委譲
            document.getElementById('sourcesContainer').addEventListener('click', (e) => {
                console.log('Container clicked, target:', e.target);
                const card = e.target.closest('.compact-card');
                console.log('Found card:', card);
                if (card) {
                    const sourceId = parseInt(card.dataset.id);
                    console.log('Card sourceId:', sourceId);
                    openEditMode(sourceId);
                }
            });

            // 編集モードのイベント委譲
            document.getElementById('editModeContainer').addEventListener('click', async (e) => {
                if (e.target.classList.contains('save-btn')) {
                    await saveSource(e.target.dataset.id);
                } else if (e.target.classList.contains('add-url-btn')) {
                    addNewUrl(e.target);
                } else if (e.target.classList.contains('remove-url-btn')) {
                    removeUrl(e.target);
                } else if (e.target.classList.contains('test-url-btn')) {
                    await testUrl(e.target);
                } else if (e.target.classList.contains('btn-close-edit')) {
                    closeEditMode();
                }
            });
        }

        // 情報源を保存
        async function saveSource(sourceId) {
            const card = document.querySelector(`[data-id="${sourceId}"]`);
            const mode = card.querySelector('.mode-select').value;
            const relevance = parseInt(card.querySelector('.relevance-input').value) || 0;
            const notes = card.querySelector('.notes-textarea').value;
            
            // URLリストを収集
            const urlInputs = card.querySelectorAll('.url-input');
            const urls = Array.from(urlInputs)
                .map(input => input.value.trim())
                .filter(url => url.length > 0);
            
            try {
                const { error } = await supabase
                    .from('sources')
                    .update({
                        acquisition_mode: mode,
                        relevance: relevance,
                        notes: notes || null,
                        urls: urls,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', sourceId);
                
                if (error) throw error;
                
                // UIを更新
                const saveBtn = card.querySelector('.save-btn');
                const originalText = saveBtn.textContent;
                saveBtn.textContent = '保存済み';
                saveBtn.classList.replace('btn-success', 'btn-outline-success');
                
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.replace('btn-outline-success', 'btn-success');
                }, 2000);
                
                // カードのスタイルを更新
                card.className = `source-card ${mode === 'disabled' ? 'disabled-source' : 
                                               mode === 'manual' ? 'manual-source' : 'auto-source'}`;
                
                // ソースデータを更新
                const sourceIndex = sources.findIndex(s => s.id == sourceId);
                if (sourceIndex !== -1) {
                    sources[sourceIndex].acquisition_mode = mode;
                    sources[sourceIndex].relevance = relevance;
                    sources[sourceIndex].notes = notes || null;
                    sources[sourceIndex].urls = urls;
                    sources[sourceIndex].updated_at = new Date().toISOString();
                }
                
                // 一覧表示を更新
                renderSources();
                
                // 統計情報を更新
                updateStats();
                
            } catch (error) {
                console.error('保存エラー:', error);
                alert('保存に失敗しました: ' + error.message);
            }
        }

        // 新しいURLを追加
        function addNewUrl(button) {
            const container = button.closest('.url-container');
            const newUrlInput = container.querySelector('.new-url-input');
            const newUrl = newUrlInput.value.trim();
            
            if (!newUrl) {
                alert('URLを入力してください');
                return;
            }
            
            if (!isValidUrl(newUrl)) {
                alert('有効なURLを入力してください');
                return;
            }
            
            // 重複チェック
            const existingUrls = Array.from(container.querySelectorAll('.url-input'))
                .map(input => input.value.trim());
            if (existingUrls.includes(newUrl)) {
                alert('このURLは既に存在します');
                return;
            }
            
            // 新しいURL項目を作成
            const urlItemsContainer = container.querySelector('.add-url-section');
            const newUrlItem = document.createElement('div');
            newUrlItem.className = 'url-item';
            newUrlItem.innerHTML = `
                <input type="url" class="form-control form-control-sm url-input" 
                       value="${escapeHtml(newUrl)}" placeholder="https://example.com/feed.xml">
                <div class="url-actions">
                    <button class="btn btn-outline-primary btn-sm test-url-btn" 
                            data-url="${escapeHtml(newUrl)}" title="URLをテスト">
                        🔍
                    </button>
                    <button class="btn btn-outline-danger btn-sm remove-url-btn" 
                            title="URLを削除">
                        ✕
                    </button>
                </div>
            `;
            
            // 追加セクションの前に挿入
            urlItemsContainer.parentNode.insertBefore(newUrlItem, urlItemsContainer);
            
            // 入力欄をクリア
            newUrlInput.value = '';
        }

        // URLを削除
        function removeUrl(button) {
            const urlItem = button.closest('.url-item');
            const container = button.closest('.url-container');
            
            // 最後のURL項目は削除を確認
            const urlItems = container.querySelectorAll('.url-item');
            if (urlItems.length === 1) {
                if (!confirm('最後のURLを削除してもよろしいですか？')) {
                    return;
                }
            }
            
            urlItem.remove();
        }

        // URLをテスト
        async function testUrl(button) {
            const url = button.dataset.url || button.closest('.url-item').querySelector('.url-input').value;
            if (!url) return;
            
            button.disabled = true;
            button.innerHTML = '⏳';
            
            try {
                // CORS制限があるため、簡易的なチェックのみ
                const response = await fetch(url, {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                button.innerHTML = '✅';
                button.className = 'btn btn-outline-success btn-sm test-url-btn';
                setTimeout(() => {
                    button.innerHTML = '🔍';
                    button.className = 'btn btn-outline-primary btn-sm test-url-btn';
                }, 3000);
                
            } catch (error) {
                button.innerHTML = '❌';
                button.className = 'btn btn-outline-danger btn-sm test-url-btn';
                setTimeout(() => {
                    button.innerHTML = '🔍';
                    button.className = 'btn btn-outline-primary btn-sm test-url-btn';
                }, 3000);
            }
            
            button.disabled = false;
        }

        // URL形式チェック
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // 編集モードを開く
        function openEditMode(sourceId) {
            console.log('openEditMode called with sourceId:', sourceId);
            console.log('sources array:', sources);
            
            const source = sources.find(s => s.id === sourceId);
            console.log('found source:', source);
            
            if (!source) {
                console.error('Source not found for id:', sourceId);
                return;
            }
            
            const editContainer = document.getElementById('editModeContainer');
            const editContent = document.getElementById('editModeContent');
            
            console.log('editContainer:', editContainer);
            console.log('editContent:', editContent);
            
            // 詳細編集カードを生成
            editContent.innerHTML = createDetailSourceCard(source);
            
            // 編集モードを表示
            editContainer.style.display = 'block';
            
            // スクロールして編集エリアを表示
            editContainer.scrollIntoView({ behavior: 'smooth' });
            
            console.log('Edit mode opened successfully');
        }

        // 編集モードを閉じる
        function closeEditMode() {
            const editContainer = document.getElementById('editModeContainer');
            editContainer.style.display = 'none';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>