# RSSÊ§úË®ºÊ©üËÉΩ‰ªò„Åç„ÅÆÊñ∞ÊÉÖÂ†±Ê∫êÁô∫Ë¶ã„ÉØ„Éº„ÇØ„Éï„É≠„Éº‰æã
# .github/workflows/discover_sources.yml „ÅÆÊã°ÂºµÁâà

name: Enhanced Source Discovery with RSS Validation

on:
  schedule:
    - cron: '0 10 * * 0'  # ÊØéÈÄ±Êó•ÊõúÊó• 10:00 UTC (19:00 JST)
  workflow_dispatch:

jobs:
  discover-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests feedparser beautifulsoup4 openai supabase
        
    - name: Run enhanced source discovery
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd scripts
        
        # 1. Êñ∞ÊÉÖÂ†±Ê∫ê„ÇíÁô∫Ë¶ãÔºàRSSÊ§úË®º‰ªò„ÅçÔºâ
        python discover_gpt_categories_enhanced.py
        
        # 2. Áô∫Ë¶ãÁµêÊûú„Çí„É¨„Éù„Éº„Éà
        echo "## üìä RSSÊ§úË®ºÁµêÊûú„Çµ„Éû„É™„Éº" >> discovery_report.md
        python -c "
        import json
        with open('discovery_results.json', 'r') as f:
            results = json.load(f)
        
        auto_count = sum(1 for r in results if r.get('acquisition_mode') == 'auto')
        manual_count = sum(1 for r in results if r.get('acquisition_mode') == 'manual')
        disabled_count = sum(1 for r in results if r.get('acquisition_mode') == 'disabled')
        
        print(f'- ü§ñ Ëá™ÂãïÂèéÈõÜÂèØËÉΩ: {auto_count}ÂÄã')
        print(f'- üë§ ÊâãÂãï„ÉÅ„Çß„ÉÉ„ÇØÊé®Â•®: {manual_count}ÂÄã') 
        print(f'- ‚ùå ÁÑ°Âäπ/„Çπ„Ç≠„ÉÉ„Éó: {disabled_count}ÂÄã')
        print(f'- üìä Á∑èÁô∫Ë¶ãÊï∞: {len(results)}ÂÄã')
        " >> discovery_report.md
        
        # 3. Pull Request‰ΩúÊàê
        if [ -f "new_sources.sql" ]; then
          python create_enhanced_pr.py
        fi
        
    - name: Archive discovery results
      uses: actions/upload-artifact@v3
      with:
        name: discovery-results
        path: |
          scripts/discovery_report.md
          scripts/discovery_results.json
          scripts/rss_validation_log.txt